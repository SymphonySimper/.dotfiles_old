#!/bin/sh

notify="dunstify"
todo_loc="$XDG_DATA_HOME"/.todo
begone_loc="$HOME"/.cache/begone

#Icons
dir="$HOME"/.local/share/icons/my-info
bat_full_i="$dir"/battery-full.svg
low_bat_i="$dir"/low-battery.svg
charging_i="$dir"/charging.svg
saver_i="$dir"/saver.svg
date_i="$dir"/date.svg
clock_i="$dir"/clock.svg
warning_i="$HOME"/.local/share/icons/general/warning.svg

get_stat=$(cat /sys/class/power_supply/BAT0/status)
get_cap=$(cat /sys/class/power_supply/BAT0/capacity)
notify_bat(){ $notify -h string:x-dunst-stack-tag:myBattery -i "$1"  "Battery level: $get_cap%"; }
bat(){
	if [ $get_stat = 'Unknown' ]; then
		notify_bat "$saver_i"
	elif [ $get_stat = 'Charging' ]; then
		notify_bat "$charging_i"
	elif [ $get_stat = 'Discharging' ]; then
		[ $get_cap -gt 20 ] && notify_bat "$bat_full_i" || notify_bat "$low_bat_i"
	fi
}

date_p="date"
get_date_txt=$($date_p "+%A %B %Y")
get_date=$($date_p "+%d/%m/%Y")
get_time=$($date_p "+%r")
notify_date(){ $notify -h string:x-dunst-stack-tag:myDate -i "$date_i" "$get_date" "$get_date_txt"; }

notify_time(){ $notify -h string:x-dunst-stack-tag:myTime -i "$clock_i"  "$get_time"; }
list_todo(){
	temp_file=$(mktemp)
	while read -r line; do
		echo "+ $line" >> $temp_file
	done < $todo_loc
	$notify -h string:x-dunst-stack-tag:todo "TODO" "$(cat $temp_file)"
	rm $temp_file
}
get_mode(){
	notify_mode(){
		get_mode_noti="$notify -h string:x-dunst-stack-tag:get_mode"
		case "$1" in
			on) $get_mode_noti -i $warning_i 'Work Mode' 'on' ;;
			off) $get_mode_noti 'Work Mode' 'off' ;;
			gaming) $get_mode_noti 'Gaming Mode' 'on' ;;
		esac
	}
	if [ -f "$begone_loc" ]; then
		case "$(cat $begone_loc | cut -d ' ' -f 2)" in
			all) notify_mode 'on' ;;
			am) notify_mode 'off' ;;
		esac
	elif [ -z "$(pgrep picom)" ]; then
		notify_mode 'gaming'
	else
		notify_mode 'off'
	fi
}

bat; notify_date; notify_time; list_todo; get_mode
