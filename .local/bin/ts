#!/bin/sh

die(){ echo "$1"; exit 1; }
if [ $# -lt 0 ]; then
	die "Requires a search term"
else
	if [ -z "$(command -v peerflix)" ]; then
		echo "Requires peerflix"
		read -p "Would you like to install it?[y/N] " ans
		case $ans in
			[Yy]* ) sudo npm install peerflix -g ;;
			* ) die;;
		esac
	fi
	[ -z "$(command -v fzf)" ] && die "Requries fzf"

	# Searx is used to search for the url
	su='https://search.ononoki.org/search?q=1377x' 
	[ -n "$XDG_CACHE_HOME" ] && cf="$XDG_CACHE_HOME"/ts || cf="$HOME"/.cache/ts
	get_tl(){ curl -s $su | grep -o 'https://www.1377x.[a-z]*/' | head -n 1 > $cf; }
	
	num=0
	while :; do
		[ ! -f $cf ] && get_tl
		tl="$(cat $cf)"
		echo $tl
		ping -c 1 $(echo $tl | cut -d '/' -f3) > /dev/null 2>&1 && break || get_tl
		[ $num -gt 5 ] && die "Urls dosen't seem to work!"
		num=$((num + 1))
	done
	movie=$(curl -s "${tl}/search/${@}/1/" | grep -Eo "torrent\/[0-9]{7}\/[a-zA-Z0-9?%-]*/" | fzf)
	[ -z "$movie" ] && die "No title selected"
	magnet=$(curl -s ${tl}/$movie | grep -Po "magnet:\?xt=urn:btih:[a-zA-Z0-9]*" | head -n 1)
	peerflix -l -k $magnet
fi
