#!/bin/sh

loc=/etc/hosts
block_source="$HOME"/.local/share/.begone
tempfile=$(mktemp)

err(){ echo "$(syl r; syl B)${1}$(syl R)"; }

noti='dunstify -h string:x-dunst-stack-tag:genHosts'
notify(){
	case "$1" in
		on) $noti "Get Work Done mode is on" "Begone sites are gone" ;;
		off) $noti "Get Work Done mode is off" "Begone? more like never gone" ;;
	esac
}

clear_block(){
	if grep -q '^# MY BLOCK' $loc; then
		if grep -q '^# MY END BLOCK' $loc; then
			$PERM sed '/^# MY BLOCK/, /^# MY END BLOCK/ { /^# MY BLOCK/! { /^# MY END BLOCK/!d; }}' -i $loc
		else
			err "MY END BLOCK is absent"
		fi
	else
		err 'MY BLOCK is absent'
	fi
	notify off
}

add_block(){
	sort $block_source -o $block_source
	for line in $( cat $block_source ); do echo "0.0.0.0\t\twww.$line" >> $tempfile; done
	$PERM sed '/^# MY BLOCK/ r /dev/stdin' -i $loc  < $tempfile
	notify on
}

is_block="$(awk '/^# MY BLOCK$/{flag=1;next}/^# MY END BLOCK$/{flag=0}flag' $loc)"

[ -n "$is_block" ] && clear_block || add_block
